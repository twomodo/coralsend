services:
  # WebSocket signaling server (mapped from Domains tab: /ws -> port 8080)
  server:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.server
    image: ${SERVER_IMAGE:-ghcr.io/alifakhimi/coralsend-server:dokploy}
    expose:
      - "8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Next.js app (mapped from Domains tab: / -> port 3000)
  web:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.web
      args:
        NEXT_PUBLIC_SIGNALING_URL: ${NEXT_PUBLIC_SIGNALING_URL:-wss://coralsend.612.ir/ws}
        NEXT_PUBLIC_BASE_PATH: ${NEXT_PUBLIC_BASE_PATH:-}
        NEXT_PUBLIC_STUN_URL: ${NEXT_PUBLIC_STUN_URL:-stun:turn.coralsend.612.ir:3478}
        NEXT_PUBLIC_TURN_URL: ${NEXT_PUBLIC_TURN_URL:-turn:turn.coralsend.612.ir:3478?transport=udp}
        NEXT_PUBLIC_TURN_USER: ${NEXT_PUBLIC_TURN_USER:-coralsend_prod}
        NEXT_PUBLIC_TURN_PASS: ${NEXT_PUBLIC_TURN_PASS:-change-this-turn-password}
    image: ${WEB_IMAGE:-ghcr.io/alifakhimi/coralsend-web:dokploy}
    expose:
      - "3000"
    depends_on:
      server:
        condition: service_healthy
    restart: unless-stopped

  # TURN/STUN service.
  # Do NOT route this service via Domains tab/HTTPS reverse proxy.
  # It must be reachable directly on UDP/TCP ports.
  coturn:
    image: coturn/coturn:4.6.3
    command:
      - -n
      - --log-file=stdout
      - --listening-port=3478
      - --min-port=49160
      - --max-port=49200
      - --realm=${TURN_REALM:-turn.coralsend.612.ir}
      - --lt-cred-mech
      - --user=${TURN_USER:-coralsend_prod}:${TURN_PASSWORD:-change-this-turn-password}
      - --external-ip=${TURN_EXTERNAL_IP:-109.199.112.84}
      - --fingerprint
      - --no-cli
    ports:
      - "3478:3478/udp"
      - "3478:3478/tcp"
      - "49160-49200:49160-49200/udp"
      - "49160-49200:49160-49200/tcp"
    restart: unless-stopped
