services:
  server:
    image: ${SERVER_IMAGE:-ghcr.io/alifakhimi/coralsend-server:latest}
    build:
      context: ../
      dockerfile: deploy/Dockerfile.server
    expose:
      - "8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 10s

  web:
    image: ${WEB_IMAGE:-ghcr.io/alifakhimi/coralsend-web:latest}
    build:
      context: ../
      dockerfile: deploy/Dockerfile.web
      args:
        - NEXT_PUBLIC_SIGNALING_URL=${NEXT_PUBLIC_SIGNALING_URL:-wss://example.com/ws}
        - NEXT_PUBLIC_BASE_PATH=${NEXT_PUBLIC_BASE_PATH:-}
        - NEXT_PUBLIC_STUN_URL=${NEXT_PUBLIC_STUN_URL:-}
        - NEXT_PUBLIC_TURN_URL=${NEXT_PUBLIC_TURN_URL:-}
        - NEXT_PUBLIC_TURN_USER=${NEXT_PUBLIC_TURN_USER:-}
        - NEXT_PUBLIC_TURN_PASS=${NEXT_PUBLIC_TURN_PASS:-}
    env_file:
      - ../.env
    environment:
      - NEXT_PUBLIC_SIGNALING_URL=${NEXT_PUBLIC_SIGNALING_URL:-wss://example.com/ws}
      - NEXT_PUBLIC_BASE_PATH=${NEXT_PUBLIC_BASE_PATH:-}
      - NEXT_PUBLIC_STUN_URL=${NEXT_PUBLIC_STUN_URL:-}
      - NEXT_PUBLIC_TURN_URL=${NEXT_PUBLIC_TURN_URL:-}
      - NEXT_PUBLIC_TURN_USER=${NEXT_PUBLIC_TURN_USER:-}
      - NEXT_PUBLIC_TURN_PASS=${NEXT_PUBLIC_TURN_PASS:-}
    expose:
      - "3000"
    depends_on:
      server:
        condition: service_healthy
    restart: unless-stopped

  coturn:
    image: coturn/coturn:4.6.3
    env_file:
      - ../.env
    command:
      - -n
      - --log-file=stdout
      - --listening-port=3478
      - --min-port=49160
      - --max-port=49200
      - --realm=${TURN_REALM:-coralsend.local}
      - --lt-cred-mech
      - --user=${TURN_USER:-coralsend}:${TURN_PASSWORD:-change-me}
      - --external-ip=${TURN_EXTERNAL_IP:-}
      - --fingerprint
      - --no-cli
    ports:
      - "3478:3478/tcp"
      - "3478:3478/udp"
      - "49160-49200:49160-49200/tcp"
      - "49160-49200:49160-49200/udp"
    restart: unless-stopped

  nginx:
    image: nginx:1.27.4
    restart: unless-stopped
    volumes:
      - ../conf.d:/etc/nginx/conf.d
    ports:
      - 80:80
      # - "443:443"
    depends_on:
      - web
      - server
